# SubmapPane Component (`src/components/SubmapPane.tsx`)

## Purpose

The `SubmapPane.tsx` component is responsible for rendering a visual representation of the player's immediate surroundings at a granular level. It displays a grid (default 25x25, defined by `submapDimensions`) representing the sub-tiles within the player's current world map tile. This enhances the player's spatial awareness and immersion during exploration by providing a more detailed, "zoomed-in" view.

Key features include:
*   **Procedural Data Generation**: Uses the `useSubmapProceduralData` custom hook to manage the generation of tile hashing logic, seeded feature placement (micro-locales), and path details.
*   **Decomposed Visual Logic**: The main visual rendering function, `getTileVisuals`, has been broken down into smaller, more focused sub-functions (`getBaseVisuals`, `applyPathVisuals`, `applySeededFeatureVisuals`, `applyScatterVisuals`) for better readability and maintainability.
*   Vastly expanded visual variety through procedurally generated feature "clumping".
*   Simple visual paths with adjacency effects.
*   A rich palette of icons and colors.
*   A modal-based icon glossary/legend to explain submap symbols.
*   Visual adjustments to specific features like villages (color and shape), camps, and monoliths (shape).
*   Unique submap generation per world map tile.
*   Artistic Enhancements like varied base tile colors, scatter icon opacity variation, and panel texture.
*   **Contextual Tile Tooltips**: Each submap tile now has a tooltip.
    *   Tiles immediately adjacent to the player display more specific, evocative hints suggesting potential points of interest or minor events related to the tile's terrain or features. These hints are now more descriptive and varied, drawing from biome-specific default lists (e.g., `forest_default`, `plains_default`) in `submapTileHints`.
    *   Other tiles (not adjacent to the player) show a generic description of their terrain type or dominant feature.
    *   **Persistent Inspected Descriptions**: After a player successfully inspects an adjacent tile, the detailed description generated by Gemini for that tile will **replace** the default tooltip content for that specific tile. This provides persistent, richer information for tiles the player has actively investigated.
    *   This uses the `Tooltip` component and an expanded set of hint strings (`submapTileHints`) within `SubmapPane.tsx`, and leverages the `inspectedTileDescriptions` prop.
*   **Player Icon**: Displays the player's icon (üßç) on their current sub-tile, with distinct styling and animation.
*   **Tile Inspection**:
    *   An "Inspect Tile" / "Cancel Inspect" button allows the player to toggle inspection mode.
    *   In this mode, adjacent tiles are highlighted, and clicking one dispatches an `INSPECT_SUBMAP_TILE` action.
    *   The UI provides feedback during inspection and **automatically resets its inspection-specific state (button label, instruction message) when the `disabled` prop (linked to `gameState.isLoading`) becomes `false` after an inspection was active.**
    *   The "Inspect Tile" / "Cancel Inspect" button's enabled/disabled state is now solely dependent on the `SubmapPane`'s `disabled` prop (i.e., `gameState.isLoading`).

The goal is to achieve a submap with a high degree of visual variety, suggesting many distinct tile appearances through the combinatorial effects of the procedural rules and providing subtle hints through tooltips, which become more detailed post-inspection.

## Props

*   **`currentWorldBiomeId: string`**:
    *   **Type**: `string`
    *   **Purpose**: The ID of the biome for the current world map tile. Used by `useSubmapProceduralData` and for selecting visual configurations and hint data.
    *   **Required**: Yes

*   **`playerSubmapCoords: { x: number; y: number }`**:
    *   **Type**: Object with `x` and `y` number properties.
    *   **Purpose**: The player's current coordinates within the submap grid. Used for highlighting, path generation logic, and determining tile adjacency for tooltips.
    *   **Required**: Yes

*   **`onClose: () => void`**:
    *   **Type**: Function
    *   **Purpose**: A callback function invoked when the player clicks the "Close" button or presses the Escape key.
    *   **Required**: Yes

*   **`submapDimensions: { rows: number; cols: number }`**:
    *   **Type**: Object with `rows` and `cols` number properties.
    *   **Purpose**: The dimensions of the submap grid.
    *   **Required**: Yes

*   **`parentWorldMapCoords: { x: number; y: number }`**:
    *   **Type**: Object with `x` and `y` number properties.
    *   **Purpose**: The coordinates of the parent world map tile. Passed to `useSubmapProceduralData` to ensure unique submap generation and used for constructing unique tile keys for inspected descriptions.
    *   **Required**: Yes

*   **`onAction: (action: Action) => void`**:
    *   **Type**: Function
    *   **Purpose**: Callback to dispatch actions, such as `INSPECT_SUBMAP_TILE`.
    *   **Required**: Yes
    
*   **`disabled: boolean`**:
    *   **Type**: `boolean`
    *   **Purpose**: Indicates if actions should be disabled (e.g., game is loading). Used to trigger UI reset after inspection and to control the enabled state of the inspect/legend buttons.
    *   **Required**: Yes

*   **`inspectedTileDescriptions: Record<string, string>`**:
    *   **Type**: `Record<string, string>`
    *   **Purpose**: A map where keys are unique tile identifiers (e.g., "worldX_worldY_subX_subY") and values are the Gemini-generated descriptions for those tiles after inspection. Used to override default tooltips with detailed information.
    *   **Required**: Yes

## Core Functionality

1.  **Modal Display**:
    *   Renders as a fixed-position overlay.
    *   The submap is contained within a styled panel with a background texture.

2.  **Grid Rendering**:
    *   Generates a 2D grid of `div` elements based on `submapDimensions`. Each `div` is wrapped by a `Tooltip` component.

3.  **Procedural Data Generation (via `useSubmapProceduralData` hook)**:
    *   The `useSubmapProceduralData` hook is responsible for:
        *   Providing a `simpleHash` function.
        *   Calculating `activeSeededFeatures`.
        *   Generating `pathDetails`.
    *   The `SubmapPane` calls this hook and uses its output for rendering.

4.  **Advanced Tile Styling & Visual Variety (`getTileVisuals` and sub-functions)**:
    *   The `getTileVisuals` function orchestrates calls to:
        *   `getBaseVisuals`: Determines the base color and initial properties.
        *   `applyPathVisuals`: Adds path and path adjacency visuals.
        *   `applySeededFeatureVisuals`: Overlays visuals for seeded features.
        *   `applyScatterVisuals`: Adds final scatter details.
    *   These functions use data from `useSubmapProceduralData` and `biomeVisualsConfig`.
    *   **Player Marker**: The player's sub-tile is highlighted with a unique icon (üßç), background color, shadow, and animation.
    *   **Edge Indication**: Sub-tiles on the submap perimeter have a distinct border.

5.  **Tooltip Generation and Display**:
    *   **`inspectedTileDescriptions` prop**: Checked first. If a description exists for the current tile's unique key, that description is used for the tooltip.
    *   **`submapTileHints`**: An expanded data structure within `SubmapPane.tsx` stores potential hint strings. It now includes more descriptive default hints for various biomes (e.g., `forest_default`, `plains_default`).
    *   **`getHintForTile` Function**:
        *   If an inspected description is found in `inspectedTileDescriptions`, it's used.
        *   Otherwise, determines if a tile is adjacent to the player's current submap coordinates.
        *   If adjacent, it selects a contextually relevant, evocative hint from `submapTileHints`, prioritizing feature-specific hints, then biome-specific terrain hints, then biome-specific default hints, before falling back to a global default.
        *   If not adjacent and not inspected, it generates a generic description.
    *   **Integration**: `getTileVisuals` calls `getHintForTile`. The `tooltipContent` is passed to a `Tooltip` component.

6.  **Tile Inspection Mode**:
    *   A button toggles `isInspecting` state. Its enabled/disabled status is now solely tied to the `disabled` prop of the `SubmapPane`.
    *   When `isInspecting`, adjacent tiles are highlighted. Clicking a highlighted tile calls `handleTileClickForInspection`.
    *   `handleTileClickForInspection` dispatches an `INSPECT_SUBMAP_TILE` action via `onAction` prop.
    *   An informational message (`inspectionMessage`) is displayed.
    *   **UI Reset**: A `useEffect` hook monitors the `disabled` prop. If `disabled` becomes `false` while `isInspecting` was true (and an inspection message was set indicating an inspection was sent), the `isInspecting` and `inspectionMessage` states are reset.

7.  **Glossary/Legend**:
    *   A "Toggle Legend" button opens a modal dialog displaying the submap legend, rendered by `GlossaryDisplay`. Its enabled/disabled status is tied to the `disabled` prop of the `SubmapPane`.

8.  **Interaction**:
    *   Closing via button or Escape key.
    *   Toggling legend and inspection mode.

9.  **Accessibility**:
    *   Modal structure with ARIA attributes.
    *   Close/legend/inspect buttons are focusable and labeled.
    *   Each sub-tile `div` has `role="img"` and an `aria-label`. Tooltips provide additional description.

## Data Dependencies

*   `src/types.ts`: For `Biome`, `GlossaryItem`, `Action`, `InspectSubmapTilePayload` types.
*   `src/constants.ts`: For `BIOMES` and `SUBMAP_DIMENSIONS` (passed via props).
*   `src/data/glossaryData.ts`: For `SUBMAP_ICON_MEANINGS`.
*   `src/components/GlossaryDisplay.tsx`: For rendering the legend.
*   `src/components/Tooltip.tsx`: For displaying tooltips on tiles.
*   `src/hooks/useSubmapProceduralData.ts`: For all procedural data generation.

## Key Improvements from Previous Version
*   **Persistent Inspected Tooltips**: Tooltips for inspected tiles now show the detailed Gemini description.
*   **Enriched Tooltips**: Adjacent tile tooltips are now significantly more descriptive and varied.
*   **Simplified Button Disabled Logic**: The "Inspect Tile" / "Cancel Inspect" and "Toggle Legend" buttons' `disabled` state now directly mirrors the `SubmapPane`'s `disabled` prop.
*   (Modularity, Readability, Tile Inspection, UI Reset, and other previous improvements remain relevant).